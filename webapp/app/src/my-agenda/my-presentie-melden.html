<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="my-presentie-melden">
    <style>
      .ziekmeld-button {
        margin-top: 20px;
        width: 100%;
        height: 2em;
        background-color: #33aadd; 
        color: white;
      }

      .ziekgemeld-button {
        margin-top: 20px;
        width: 100%;
        height: 2em;
        cursor: default;
      }
    </style>
    <template>
        <paper-button
          id="login_button_element"
          class="ziekmeld-button"
          on-tap="openDialog"
          raised
          hidden$="{{afwezig}}">
            Afmelden
         </paper-button>

         <div hidden$="{{!afwezig}}">
            <paper-button
            id="login_button_element"
            class="ziekgemeld-button"
            raised
            hidden$="{{!ziek}}">
              Ziek
           </paper-button>

          <paper-button
            id="login_button_element"
            class="ziekgemeld-button"
            raised
            hidden$="{{!afgemeld}}">
              Afgemeld
           </paper-button>
         </div>

        <paper-dialog id="presentieMelden" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
          <h2>Afmelden</h2>
          <paper-dropdown-menu label="Reden invoeren" on-iron-select="_itemSelected">
            <paper-menu class="dropdown-content">
              <paper-item value="1">Ziek</paper-item>
              <paper-item value="2">Afmelden</paper-item>
            </paper-menu>
          </paper-dropdown-menu>

           <paper-input hidden$="{{!redenVeldWeergeven}}" id="afmeldReden" label="Reden afmelden" value="{{ redenVeld }}"></paper-input>

          <div class="buttons">
            <paper-button dialog-dismiss>Sluiten</paper-button>
            <paper-button dialog-confirm autofocus on-tap="confirmDialog" hidden$="{{!displayMelden}}">Melden</paper-button>
          </div>
    
        </paper-dialog>

        <iron-ajax
          id="ajax_student_rooster_afmelden"
          method="POST"
          url="/student/rooster/afmelden"
          handle-as="json"
          on-response="_student_rooster_afmelden_response_handler">
        </iron-ajax>

        <iron-ajax
          id="ajax_student_rooster_current"
          method="POST"
          url="/docent/rooster/les/presentie/current"
          handle-as="text"
          on-response="_student_rooster_current_response_handler">
        </iron-ajax>

    </template>
    <script>
        Polymer({
            is: 'my-presentie-melden',
            properties: {
              ziek: {
                type: Boolean,
                value: false,
                notify: true, 
              },

              afgemeld: {
                type: Boolean,
                value: false,
                notify: true, 
              },

              afwezig: {
                type: Boolean,
                value: false,
                notify: true, 
              },

              redenVeldWeergeven: {
                type: Boolean,
                value: false,
                notify: true, 
              },
              redenVeld: {
                type: String,
              },
              redenOptie: {
                type: String,
              },
              displayMelden: {
                type: Boolean,
                value: false,
                notify: true,               
              },

              item: {
                type: Object,
                notify: true,               
              },

              c_username: {
                type: String,
                observer: '_initializing',
              },

            },

            _initializing : function() {
              this.$.ajax_student_rooster_current.contentType = "application/json";
              this.$.ajax_student_rooster_current.body = {
                  "datum": this.item.datum,
                  "begin": this.item.begin,
                  "eind": this.item.eind,
                  "username": this.c_username,
                  "vak": this.item.vak,
              };

              this.$.ajax_student_rooster_current.generateRequest();
            },

            openDialog: function() {
              this.$.presentieMelden.open();
            },

            confirmDialog: function() {

              if(this.redenOptie == "Afmelden"){
                if(this.redenVeld.length < 3){
                  alert('Reden is te kort');
                  
                  var that = this;
                   setTimeout(function () {
                      that.$.presentieMelden.open();
                  }, 200);

                  return;
                }
              }

              this.$.ajax_student_rooster_afmelden.contentType = "application/json";
              this.$.ajax_student_rooster_afmelden.body = {
                  "datum": this.item.datum,
                  "begin": this.item.begin,
                  "eind": this.item.eind,
                  "username": this.c_username,
                  "vak": this.item.vak,
                  "redenoptie": this.redenOptie,
                  "redenveld": this.redenVeld,
              };

              this.$.ajax_student_rooster_afmelden.generateRequest();

              this.afgemeld = true;
            },

            _student_rooster_afmelden_response_handler: function (request) {
            },

            _student_rooster_current_response_handler: function (request) {
              var response = JSON.parse(request.detail.response).value;
              console.log(response);
            },

            _itemSelected : function(e) {
              var selectedItem = e.target.selectedItem;
              if (selectedItem) {

                this.redenOptie = selectedItem.innerText;
                this.displayMelden = true;

                if(selectedItem.innerText == "Afmelden"){
                  this.redenVeldWeergeven = true;
                }else{
                  this.redenVeldWeergeven = false;
                }

              }
            },
        });
    </script>
</dom-module>